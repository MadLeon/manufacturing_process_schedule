' ------ UserForm: Form_BatchInput ------
Option Explicit

Private ButtonHandlers() As Object

' ------- Core: Generate dynamic inputs -----
Public Sub PrepareForm(ByVal numItems As Long)
    ' Layout and sizing config
    Dim colWidth As Long: colWidth = 120
    Dim rowHeight As Long: rowHeight = 25
    Dim formPadding As Long: formPadding = 50
    Dim btnWidth As Long: btnWidth = 60
    Dim btnHeight As Long: btnHeight = 20
    Dim btnSpacing As Long: btnSpacing = 10
    Dim componentTop As Long: componentTop = 24  ' Top Y of static controls
    Dim textboxHeight As Long: textboxHeight = 24

    ' Determine columns based on item count
    Dim numCols As Long
    Select Case numItems
        Case 1 To 20: numCols = 2
        Case 21 To 30: numCols = 3
        Case 31 To 40: numCols = 4
        Case Else: numCols = Int((numItems - 1) / 10) + 1
    End Select

    ' Remove previous dynamic controls
    Dim ctl As control
    For Each ctl In Me.Controls
        If Left(ctl.Name, 7) = "txtItem" Or Left(ctl.Name, 6) = "lblItem" Or _
           ctl.Name = "btnOK" Or ctl.Name = "btnCancel" Then
            Me.Controls.Remove ctl.Name
        End If
    Next ctl

    ' Store item count
    Data_SharedValues.ItemCount = numItems
    ReDim Data_SharedValues.BatchValues(1 To numItems)

    ' Calculate rows per column (ceil division)
    Dim numRowsPerCol As Long
    numRowsPerCol = (numItems + numCols - 1) \ numCols

    ' Add dynamic txt/lbl controls below static area
    Dim i As Long, currentCol As Long, currentRow As Long
    Dim lbl As MSForms.Label, tb As MSForms.TextBox
    For i = 1 To numItems
        currentCol = (i - 1) \ numRowsPerCol
        currentRow = (i - 1) Mod numRowsPerCol

        Set lbl = Me.Controls.Add("Forms.Label.1", "lblItem" & i, True)
        lbl.Caption = i & "."
        lbl.Top = componentTop + textboxHeight + 8 + currentRow * rowHeight
        lbl.Left = 10 + currentCol * colWidth
        lbl.Width = 15

        Set tb = Me.Controls.Add("Forms.TextBox.1", "txtItem" & i, True)
        tb.Top = lbl.Top - 3
        tb.Left = lbl.Left + lbl.Width + 3
        tb.Width = 80
        tb.Text = ""
    Next i

    ' Adjust form size (width/height)
    Me.Width = 30 + numCols * colWidth
    Dim lastRowTop As Long
    lastRowTop = componentTop + textboxHeight + 8 + numRowsPerCol * rowHeight
    Me.Height = lastRowTop + btnHeight + formPadding

    ' Add OK/Cancel buttons at form bottom right
    Dim btnOK As MSForms.CommandButton, btnCancel As MSForms.CommandButton
    Set btnOK = Me.Controls.Add("Forms.CommandButton.1", "btnOK", True)
    btnOK.Caption = "OK"
    btnOK.Width = btnWidth
    btnOK.Height = btnHeight
    btnOK.Left = Me.Width - btnWidth * 2 - btnSpacing * 2 - 15
    btnOK.Top = Me.Height - btnHeight - btnSpacing - 30

    Set btnCancel = Me.Controls.Add("Forms.CommandButton.1", "btnCancel", True)
    btnCancel.Caption = "Cancel"
    btnCancel.Width = btnWidth
    btnCancel.Height = btnHeight
    btnCancel.Left = Me.Width - btnWidth - btnSpacing - 15
    btnCancel.Top = btnOK.Top

    ReDim ButtonHandlers(1 To 2)
    Set ButtonHandlers(1) = New Handler_BatchInputOKButton
    Set ButtonHandlers(1).Btn = btnOK
    Set ButtonHandlers(2) = New Handler_BatchInputCancelButton
    Set ButtonHandlers(2).Btn = btnCancel

    Me.Controls("txtItem1").SetFocus
End Sub

' ------- Random number button click event ---------
Private Sub GenRandomNumber_Click()
    ' Check if both textboxes are empty
    If Trim(Me.UpperTolerance.Text) = "" And Trim(Me.LowerTolerance.Text) = "" Then
        Exit Sub ' Do nothing if both empty
    End If

    ' Check if ONLY one textbox has a value
    Dim upperTol As Double, lowerTol As Double, decPlaces As Long, resultVal As Double
    Dim upperDp As Long, lowerDp As Long
    Dim minVal As Double, maxVal As Double, stepSize As Double, numSteps As Long, i As Long, randIndex As Long, resultStr As String
    Dim possibleVals() As Double
    If Trim(Me.UpperTolerance.Text) <> "" And Trim(Me.LowerTolerance.Text) = "" Then
        ' Only upper tolerance has a value
        On Error GoTo ValueError
        upperTol = ToNumber(Me.UpperTolerance.Text)
        lowerTol = upperTol ' Set lower = upper
        minVal = upperTol
        On Error GoTo 0
    ElseIf Trim(Me.LowerTolerance.Text) <> "" And Trim(Me.UpperTolerance.Text) = "" Then
        ' Only lower tolerance has a value
        On Error GoTo ValueError
        lowerTol = ToNumber(Me.LowerTolerance.Text)
        upperTol = lowerTol  ' Set upper = lower
        minVal = lowerTol
        On Error GoTo 0
    Else
        ' Both have values, proceed as before
        On Error GoTo ValueError
        upperTol = ToNumber(Me.UpperTolerance.Text)
        lowerTol = ToNumber(Me.LowerTolerance.Text)
        On Error GoTo 0
    End If

    ' Get decimal places of input
    upperDp = CountDecimalPlaces(Me.UpperTolerance.Text)
    lowerDp = CountDecimalPlaces(Me.LowerTolerance.Text)
    decPlaces = IIf(upperDp > lowerDp, upperDp, lowerDp)

    minVal = lowerTol
    maxVal = upperTol
    If maxVal = 0 Then
        maxVal = 0.000001
    End If

    stepSize = 1 / (10 ^ decPlaces)
    numSteps = Round((maxVal - minVal) / stepSize)
    If numSteps < 0 Then
        MsgBox "Upper Tolerance must be greater than or equal to Lower Tolerance.", vbExclamation, "Input Error"
        Exit Sub
    End If
    If numSteps = 0 Then
        numSteps = 1
    End If

    ' Create all possible values within range
    ReDim possibleVals(0 To numSteps - 1)
    For i = 0 To numSteps - 1
        possibleVals(i) = WorksheetFunction.Round(minVal + i * stepSize, decPlaces)
    Next i
     ' --------- Begin: Handle leading zero style ---------
    ' Check if either input starts with "0."
    Dim showLeadingZero As Boolean
    showLeadingZero = (Left(Trim(Me.UpperTolerance.Text), 2) = "0." Or Left(Trim(Me.LowerTolerance.Text), 2) = "0.")
    ' --------- End: Handle leading zero style ---------
    ' Fill each dynamic textbox with a random value or with a single value
    Dim idx As Long
    If (Trim(Me.UpperTolerance.Text) <> "" And Trim(Me.LowerTolerance.Text) = "") Or (Trim(Me.LowerTolerance.Text) <> "" And Trim(Me.UpperTolerance.Text) = "") Then
            For idx = 1 To Data_SharedValues.ItemCount
                If decPlaces > 0 Then
                     If showLeadingZero Then
                       resultStr = Format(minVal, "0." & String(decPlaces, "0"))
                     Else
                        resultStr = Format(minVal, "#." & String(decPlaces, "0"))
                     End If
                Else
                    resultStr = CStr(minVal)
                End If
                Me.Controls("txtItem" & idx).Text = resultStr
            Next idx
    Else
       For idx = 1 To Data_SharedValues.ItemCount
            Randomize
            randIndex = Int((UBound(possibleVals) - LBound(possibleVals) + 1) * Rnd + LBound(possibleVals))
            resultVal = possibleVals(randIndex)
             ' Format number to required decimal places
            If decPlaces > 0 Then
                resultStr = Format(resultVal, "0." & String(decPlaces, "0"))
                 ' Remove leading zero if user input does not start with "0."
                If Not showLeadingZero And Abs(resultVal) < 1 And resultVal <> 0 Then
                    If Left(resultStr, 2) = "0." Then
                        resultStr = Mid(resultStr, 2)
                    ElseIf Left(resultStr, 3) = "-0." Then
                        resultStr = "-" & Mid(resultStr, 3)
                    End If
                End If
            Else
                resultStr = CStr(resultVal)
            End If
            Me.Controls("txtItem" & idx).Text = resultStr
        Next idx
    End If
    Exit Sub
ValueError:
    MsgBox "One or both input values are not valid numbers!", vbExclamation, "Input Error"
End Sub
